#!/bin/bash

#acpis - acpi status
#Matthias Endler
#Free distribution under the GNU GPL licence
#NO WARRANTY !

case "$1" in
""|-s|--status)
	case "$2" in
		1)
		cat /proc/acpi/thermal_zone/THRM/temperature | awk '{ print $2 }'
		exit 0
		;;
		2)
		cat /proc/acpi/fan/FN1/state | awk '{ print $2 }'
		exit 0
		;;
		3)
		cat /proc/acpi/fan/FN2/state | awk '{ print $2 }'
		exit 0
		;;
		4)
		cat /proc/acpi/battery/BAT0/state | grep charging | awk '{ print $3 }'
		exit 0
		;;
		5)
		cat /proc/acpi/processor/CPU0/throttling | grep "*" | awk '{ print $2 }'
		exit 0
		;;
	esac
	echo "acpi status:"
	echo -n "core " && cat /proc/acpi/thermal_zone/THRM/temperature
	echo -n "fan1 " && cat /proc/acpi/fan/FN1/state
	echo -n "fan2 " && cat /proc/acpi/fan/FN2/state
	echo    "batt " && cat /proc/acpi/battery/BAT0/state | grep charging
	echo -n "proc throttling:              "
	cat /proc/acpi/processor/CPU0/throttling | grep "*" | awk '{ print $2 }'
	exit 0
	;;

-f|--fan)
	echo "Syntax: acpis -f [number] [on/off]"
	case "$2" in
	1|2)
		if [ "$3" == "on" ]; then
			echo "Switching on fan" $2
			echo -n 0 > /proc/acpi/fan/FN$2/state
        	elif [ "$3" == "off" ]; then
			echo "Switching off fan" $2
			echo -n 0 > /proc/acpi/fan/FN$2/state
			sleep 1
			echo -n 3 > /proc/acpi/fan/FN$2/state
		fi
		exit 0
	;;

	""|3|all)
		case "$3" in
		on)
			echo "Switching all fans on"
			echo -n 0 > /proc/acpi/fan/FN1/state
			echo -n 0 > /proc/acpi/fan/FN2/state
		;;
   
		""|off)
			echo -n "Switching all fans off..."
			echo -n 0 > /proc/acpi/fan/FN1/state
			echo -n 0 > /proc/acpi/fan/FN2/state
			sleep 1
			echo -n 3 > /proc/acpi/fan/FN1/state
			echo -n 3 > /proc/acpi/fan/FN2/state
			echo "done"
		;;
		esac
		exit 0
		;;
	esac
	;;
 
	--cool)
		echo -n "Resetting trip_points..."
		echo "90:70:63:50:40" > /proc/acpi/thermal_zone/THRM/trip_points
		echo "done"
		echo -n "Switching all fans on..."
		echo -n 0 > /proc/acpi/fan/FN1/state
		echo -n 0 > /proc/acpi/fan/FN2/state
		echo "done"
	;;

	--silence|--maximum)
		echo "Setting trip_points..."
		if [ "$2" == "" ]; then
			echo "90:80:70:66:40" > /proc/acpi/thermal_zone/THRM/trip_points
		else
			echo $2 
			echo "$2" > /proc/acpi/thermal_zone/THRM/trip_points
		fi
	cat /proc/acpi/thermal_zone/THRM/trip_points
	echo -n "Switching all fans off..."
	echo -n 0 > /proc/acpi/fan/FN1/state
	echo -n 0 > /proc/acpi/fan/FN2/state
	sleep 1
	echo -n 3 > /proc/acpi/fan/FN1/state
	echo -n 3 > /proc/acpi/fan/FN2/state
	echo "done"
	if [ "$1" == "--maximum" ]; then
		echo -n 7 > /proc/acpi/processor/CPU0/throttling
	echo "Processor speed: 13%"
	echo "Maximum mode reached."		
	fi
	;;

	-t|--throttle)
	CPUSPEED=`cat /proc/acpi/processor/CPU0/throttling|grep active|awk {'print $3'}|tr -d T`
	case "$2" in
		0|1|2|3|4|5|6|7)
		echo -n "Reducing processor speed by "
		echo -n $2 > /proc/acpi/processor/CPU0/throttling
		cat /proc/acpi/processor/CPU0/throttling | grep "*" | awk '{ print $2 }'
	;;

	+)
		if [ "$CPUSPEED" -gt "0" ] ; then
			CPUSPEED=$(expr $CPUSPEED - 1)
			echo -n $CPUSPEED>/proc/acpi/processor/CPU0/throttling
			echo -n "Increased cpu speed. Throttling:"
			cat /proc/acpi/processor/CPU0/throttling | grep "*" | awk '{ print $2 }'
		fi
	;;

	-)
		if [ "$CPUSPEED" -lt "7" ] ; then
			CPUSPEED=$(expr $CPUSPEED + 1)
			echo -n $CPUSPEED>/proc/acpi/processor/CPU0/throttling
			echo -n "Decreased cpu speed. Throttling:"
			cat /proc/acpi/processor/CPU0/throttling | grep "*" | awk '{ print $2 }'
		fi
	;;
	esac
	;;

	-h|--help)
		echo "acpis"
		echo "-s --status                    shows information about your acpi interface"
		echo "-h --help                      display this help and exit"
		echo "-v --version                   display version and exit"
		echo "-f --fan [number] [status]     turn fan [number] [on/off]"
		echo "-t --throttle                  [0|1|2|3|4|5|6|7|+|-] 
increase/decrease cpu frequency"
		echo "   --silence                   Set high trip points and turn off all fans"
		echo "   --cool                      Opposite of silence :)"
		echo "-m --maximum                   Dangerous! Combination of all power saving methods"
		exit 0
	;;

	-v|--version)
		echo "acpis version 0.02 beta"
		echo "Written by Matthias Endler"
		echo "Published under the terms of the GNU GPL"
		echo "Distributed with NO WARRANTY!"
		exit 0
	;;
esac
exit 0
